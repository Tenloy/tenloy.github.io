<!DOCTYPE html>
<html lang="en">
    <!-- title -->




<!-- keywords -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="Tenloy">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Tenloy">
    
    <meta name="keywords" content="Tenloy,iOS,Swift">
    
    <meta name="description" content="学习 生活 记录 回忆">
    <meta name="description" content="一、Crash概述1.1 常见Crash的类型常见的 crash 类型总结下来，分为三种：  Mach kernel exceptions：是指最底层的内核级异常。用户态的开发者可以直接通过Mach API设置thread，task，host的异常端口，来捕获Mach异常。 Unix Fatal signals：又称BSD 信号，如果开发者没有捕获Mach异常，则会被host层的方法ux_exce">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS崩溃监控与分析">
<meta property="og:url" content="https://tenloy.github.io/2021/08/01/Crash-Monitor.html">
<meta property="og:site_name" content="Tenloy&#39;s Blog">
<meta property="og:description" content="一、Crash概述1.1 常见Crash的类型常见的 crash 类型总结下来，分为三种：  Mach kernel exceptions：是指最底层的内核级异常。用户态的开发者可以直接通过Mach API设置thread，task，host的异常端口，来捕获Mach异常。 Unix Fatal signals：又称BSD 信号，如果开发者没有捕获Mach异常，则会被host层的方法ux_exce">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tenloy.github.io/images/crash/2846924-a0cccb53e95db4d8.png">
<meta property="og:image" content="https://tenloy.github.io/images/RunLoop/RunLoop_3.png">
<meta property="og:image" content="https://tenloy.github.io/images/RunLoop/RunLoop_4.png">
<meta property="og:image" content="https://tenloy.github.io/images/crash/os-structure2.png">
<meta property="og:image" content="https://tenloy.github.io/images/crash/Mach-except-handle.jpg">
<meta property="og:image" content="https://tenloy.github.io/images/crash/1435544422851512.png">
<meta property="og:image" content="https://tenloy.github.io/images/crash/BSD-signals.jpg">
<meta property="og:image" content="https://tenloy.github.io/images/crash/mach-bsd.png">
<meta property="article:published_time" content="2021-08-01T08:24:21.000Z">
<meta property="article:modified_time" content="2025-06-16T07:38:33.930Z">
<meta property="article:author" content="Tenloy">
<meta property="article:tag" content="CrashMonitor">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tenloy.github.io/images/crash/2846924-a0cccb53e95db4d8.png">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    
    <title>iOS崩溃监控与分析 · Tenloy&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= "/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= "/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/favicon.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
        <!-- algolia -->
        <script>
            
            var hits = JSON.parse('{"per_page":10}')
            var labels = JSON.parse('{"input_placeholder":"Search for Posts","hits_empty":"没有找到任何搜索结果: ${query}","hits_stats":"找到约${hits}条结果（用时${time}ms）"}')

            var algolia = {
                applicationID: 'V0HYXBS9FB',
                apiKey: '6550d5de786935564142097c3e78c380',
                indexName: 'law_blog_index',
                hits: hits,
                labels: labels
            }
        </script>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Tenloy's Blog" type="application/atom+xml">
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >Tenloy&#39;s Blog</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">iOS崩溃监控与分析</a>
            </div>
    </div>
    
    <!-- 将home-link的操作改为应用到header-top-right上 -->
    <div class="header-top-right">
        <!-- search  -->
        
            <div class="site-search popup-trigger tl-search">
                <span class="iconfont-jian tl-search-icon">&#xe7fc;搜索</span>
            </div>
            
        <a class="home-link" href=/>Tenloy's Blog</a>
    </div>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:40vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            iOS崩溃监控与分析
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "CrashMonitor">CrashMonitor</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count word-count">8.6k</span>Reading time: <span class="post-count reading-time">35 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2021/08/01</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h1 id="一、Crash概述"><a href="#一、Crash概述" class="headerlink" title="一、Crash概述"></a>一、Crash概述</h1><h2 id="1-1-常见Crash的类型"><a href="#1-1-常见Crash的类型" class="headerlink" title="1.1 常见Crash的类型"></a>1.1 常见Crash的类型</h2><p>常见的 crash 类型总结下来，分为三种：</p>
<ul>
<li>Mach kernel exceptions：是指最底层的内核级异常。用户态的开发者可以直接通过Mach API设置thread，task，host的异常端口，来捕获Mach异常。</li>
<li>Unix Fatal signals：又称BSD 信号，如果开发者没有捕获Mach异常，则会被host层的方法ux_exception()将异常转换为对应的UNIX信号，并通过方法threadsignal()将信号投递到出错线程。可以通过方法signal(x, SignalHandler)来捕获single。<ul>
<li><strong>很多内存错误、访问错误的地址造成的异常会以Mach异常、unix标准的signal机制的形式造成crash的现象。</strong></li>
</ul>
</li>
<li>应用级异常：<ul>
<li>Objective-C exceptions（NSException），它是未被捕获的Objective-C异常，导致程序向自身发送了SIGABRT信号而崩溃，对于未捕获的Objective-C异常，是可以通过try catch来捕获的，或者通过NSSetUncaughtExceptionHandler()机制来捕获。</li>
<li>C++ exceptions</li>
<li>Main thread deadlock (experimental)  主线程死锁</li>
<li>Custom crashes (e.g. from scripting languages) 自定义崩溃</li>
</ul>
</li>
</ul>
<p>此外，在iOS中还有一些信号捕获不到的崩溃。<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/88600">12 | iOS 崩溃千奇百怪，如何全面监控？</a></p>
<ul>
<li>后台任务超时导致的崩溃。<ul>
<li>在使用Background Task 方式进行后台保活时，任务最多执行 3 分钟，3 分钟内 yourTask 运行完成，你的 App 就会挂起。 如果 yourTask 在 3 分钟之内没有执行完的话，系统会强制杀掉进程，从而造成崩溃，这就是为什么 App 退后台容易出现崩溃的原因。</li>
</ul>
</li>
<li>内存打爆、主线程卡顿时间超过阈值被 watchdog 杀掉。</li>
</ul>
<h2 id="1-2-处理流程"><a href="#1-2-处理流程" class="headerlink" title="1.2 处理流程"></a>1.2 处理流程</h2><p>参考图：</p>
<img src="/images/crash/2846924-a0cccb53e95db4d8.png" alt="" style="zoom:100%;" />

<h1 id="二、Darwin操作系统简单介绍"><a href="#二、Darwin操作系统简单介绍" class="headerlink" title="二、Darwin操作系统简单介绍"></a>二、Darwin操作系统简单介绍</h1><p>可以通过下面两张图，简单的看一下OS/iOS系统的分层结构</p>
<img src="/images/RunLoop/RunLoop_3.png" alt="os-structure" style="zoom:60%;" />

<p>Darwin是macOS和iOS操作环境的操作系统部分。苹果公司于2000年把Darwin发布给开放源代码社区。</p>
<ul>
<li>既然是OS，那肯定要包括系统内核XNU、驱动、Shell 等内容，这一层是开源的，其所有源码都可以在 <a target="_blank" rel="noopener" href="http://opensource.apple.com/">opensource.apple.com</a> 里找到。</li>
<li>XNU是一个混合内核，它采用了来自OSF的OSFMK 7.3(Open Software Foundation Mach Kernel)和FreeBSD的各种要素(包括过程模型，网络堆栈和虚拟文件系统)，还有一个称为I/O Kit的面向对象的设备驱动程序API。<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Mach">Mach</a>是一个由卡内基梅隆大学开发的计算机操作系统微内核，为了用于操作系统之研究，特别是在分布式与并行运算上。是最早实现微核心操作系统的例子之一，是许多其它相似的项目的标准。</li>
<li>OSFMK 是 Unix 操作系统的一个变体，是很早的使用 Mach kernel 的操作系统之一。</li>
<li>BSD伯克利软件套件(Berkeley Software Distribution UNIX)，是一个派生自Unix（类Unix）的操作系统。</li>
<li>FreeBSD是FreeBSD项目的发展成果，是开放源代码的类Unix操作系统，基于BSD Unix的源代码派生发展而来。</li>
</ul>
</li>
<li>XNU将宏内核与微内核两者的特性兼收并蓄，以期同时拥有两种内核的优点。<strong>微内核的灵活性</strong>：比如在微内核中提高操作系统模块化程度以及让操作系统更多的部分接受内存保护的消息传递机制。<strong>宏内核的性能</strong>：宏内核在高负荷下表现的高性能。</li>
</ul>
<p>我们在深入看一下 Darwin 这个核心的架构：</p>
<img src="/images/RunLoop/RunLoop_4.png" alt="os-structure" style="zoom:70%;" />

<p>其中，在硬件层上面的三个组成部分：Mach、BSD、IOKit (还包括一些上面没标注的内容)，共同组成了 XNU 内核。</p>
<ul>
<li>XNU 内核的内环被称作 Mach，其作为一个微内核，仅提供了诸如处理器调度、IPC (进程间通信)等非常少量的基础服务。</li>
<li>BSD 层可以看作围绕 Mach 层的一个外环，其提供了诸如进程管理、文件系统和网络等功能。(BSD是宏内核)</li>
<li>IOKit 层是为设备驱动提供了一个面向对象(C++)的一个框架。</li>
</ul>
<p>Mach 本身提供的 API 非常有限，而且苹果也不鼓励使用 Mach 的 API，但是这些API非常基础，如果没有这些API的话，其他任何工作都无法实施。在 Mach 中，所有的东西都是通过自己的对象实现的，进程、线程和虚拟内存都被称为”对象”。和其他架构不同， Mach 的对象间不能直接调用，只能通过消息传递的方式实现对象间的通信。”消息”是 Mach 中最基础的概念，消息在两个端口 (port) 之间传递，这就是 Mach 的 IPC (进程间通信) 的核心。 也是RunLoop的底层实现支持技术。</p>
<p>iOS中的 POSIX API 就是通过 Mach 之上的 BSD 层实现的：</p>
<p><img src="/images/crash/os-structure2.png" alt="os-structure2"></p>
<h1 id="三、捕获-—-Mach异常与Unix信号异常"><a href="#三、捕获-—-Mach异常与Unix信号异常" class="headerlink" title="三、捕获 — Mach异常与Unix信号异常"></a>三、捕获 — Mach异常与Unix信号异常</h1><p>iOS系统自带的 Apple’s Crash Reporter 记录在设备中的Crash日志，Exception Type项通常会包含两个元素： Mach异常 和 Unix信号。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception Type:         EXC_BAD_ACCESS (SIGSEGV)    </span><br><span class="line">Exception Subtype:      KERN_INVALID_ADDRESS at 0x041a6f3</span><br></pre></td></tr></table></figure>

<p>Mach异常是什么？它又是如何与Unix信号建立联系的？</p>
<h2 id="3-1-Mach-kernel-exceptions"><a href="#3-1-Mach-kernel-exceptions" class="headerlink" title="3.1 Mach kernel exceptions"></a>3.1 Mach kernel exceptions</h2><h3 id="3-1-1-Mach异常的产生"><a href="#3-1-1-Mach异常的产生" class="headerlink" title="3.1.1 Mach异常的产生"></a>3.1.1 Mach异常的产生</h3><p>Mach异常是指最底层的内核级异常。</p>
<p>捕获方法：每个thread，task，host都有一个异常端口数组，Mach的部分API暴露给了用户态，用户态的开发者可以直接通过Mach API设置thread，task，host的异常端口，来捕获Mach异常，抓取Crash事件。</p>
<img src="/images/crash/Mach-except-handle.jpg" alt="Mach-except-handle" style="zoom:60%;" />

<h3 id="3-1-2-Mach异常的捕获原理"><a href="#3-1-2-Mach异常的捕获原理" class="headerlink" title="3.1.2 Mach异常的捕获原理"></a>3.1.2 Mach异常的捕获原理</h3><img src="/images/crash/1435544422851512.png" alt="" style="zoom:90%;" />

<h2 id="3-2-Unix-BSD-Signals"><a href="#3-2-Unix-BSD-Signals" class="headerlink" title="3.2 Unix/BSD Signals"></a>3.2 Unix/BSD Signals</h2><p>Unix信号，又称为BSD 信号。</p>
<h3 id="3-2-1-信号的产生"><a href="#3-2-1-信号的产生" class="headerlink" title="3.2.1 信号的产生"></a>3.2.1 信号的产生</h3><p>Mach已经通过异常机制提供了底层的异常处理，但为了兼容更为流行的POSIX标准(SUS规范)，BSD在Mach异常机制之上构建的UNIX信号处理机制。这样不必了解Mach内核也可以通过Unix信号的方式来兼容开发。</p>
<ul>
<li>Mach异常如果没在Mach级别处理，那么都会在host层被ux_exception转换为相应的Unix信号，并通过threadsignal将信号投递到出错的线程。</li>
<li>另外，不是所有的 “Mach异常” 类型都映射到了 “UNIX信号”。 如 EXC_GUARD 。在苹果开源的 xnu 源码中可以看到这点。</li>
<li>因为硬件产生的信号（通过CPU陷阱）被Mach层捕获，然后才转换为对应的Unix信号；苹果为了统一机制，于是操作系统和用户产生的信号（通过调用kill和pthread_kill）也首<strong>先沉下来被转换为Mach异常，再转换为Unix信号。</strong></li>
</ul>
<p>因此，EXC_BAD_ACCESS (SIGSEGV)表示的意思是：Mach层的EXC_BAD_ACCESS异常，在host层被转换成SIGSEGV信号投递到出错的线程。</p>
<img src="/images/crash/BSD-signals.jpg" alt="BSD-signals" style="zoom:60%;" />

<h3 id="3-2-2-信号的捕获原理"><a href="#3-2-2-信号的捕获原理" class="headerlink" title="3.2.2 信号的捕获原理"></a>3.2.2 信号的捕获原理</h3><h4 id="1-signal函数"><a href="#1-signal函数" class="headerlink" title="1. signal函数"></a>1. signal函数</h4><p>既然最终以信号的方式投递到出错的线程，那么就可以通过注册signalHandler来捕获信号:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGSEGV,signalHandler);</span><br></pre></td></tr></table></figure>

<h4 id="2-sigaction函数"><a href="#2-sigaction函数" class="headerlink" title="2. sigaction函数"></a>2. sigaction函数</h4><p>如果需要用相同的方式处理信号多次出现，且信号容易多次出现，则建议使用sigaction函数；若可以保证信号长时间内只出现并只需要处理一次，则可以使用signal函数。</p>
<h3 id="3-2-3-系统中都有哪些信号"><a href="#3-2-3-系统中都有哪些信号" class="headerlink" title="3.2.3 系统中都有哪些信号"></a>3.2.3 系统中都有哪些信号</h3><p>默认情况下，大多数信号都是致命的（Fatal signals）。 任何具有“terminate终止”或“dump core核心转储”的默认操作的信号都是致命的，除非它被忽略或明确处理。查看方式：</p>
<ul>
<li><code>usr/include/sys/signal.h</code> 中，定义了31种</li>
<li>也可以使用命令 <code>kill -l</code> 查看，显示了25种</li>
<li>针对特定的信号，应用程序可以写对应的信号处理函数。如果不指定，则采取默认的处理方式</li>
<li>core dump：是操作系统在进程收到某些信号而终止运行时，将此时进程地址空间的内容以及有关进程状态的其他信息写出的一个磁盘文件(有的系统中将文件命名为 <code>core.进程号</code>，也有的命名为 <code>core-命令名-pid-时间戳</code>)。这种信息往往用于调试。</li>
</ul>
<h2 id="3-3-常见的Mach异常与Unix信号"><a href="#3-3-常见的Mach异常与Unix信号" class="headerlink" title="3.3 常见的Mach异常与Unix信号"></a>3.3 常见的Mach异常与Unix信号</h2><p><strong>信号可以看做是对硬件异常跟软件异常的封装</strong>，常见的几种signals：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SIGSEGV, <span class="comment">// SEGV segmentation violation(段 违反) 非法访问地址，比如试图访问未分配给自己的内存, 或试图往没有写权限的内存地址写数据。比如：给已经release的对象发送消息</span></span><br><span class="line">SIGBUS,  <span class="comment">// 操作非法地址。比如修改只读数据区。</span></span><br><span class="line">SIGILL,  <span class="comment">// 执行非法指令, 通常是因为可执行文件本身出现错误, 或者试图执行数据段. 堆栈溢出时也有可能产生这个信号。</span></span><br><span class="line">SIGFPE,  <span class="comment">// 算术运算错误</span></span><br><span class="line">SIGSYS,  <span class="comment">// 非法的系统调用</span></span><br><span class="line">SIGPIPE, <span class="comment">// 进程间通信产生，通信管道破裂。这个信号通常在进程间通信产生，比如采用FIFO(管道)通信的两个进程，读管道没打开或者意外终止就往管道写，写进程会收到SIGPIPE信号。此外用Socket通信的两个进程，写进程在写Socket的时候，读进程已经终止。</span></span><br><span class="line">SIGABRT, <span class="comment">// 调用abort生成的信号，有可能是NSException也有可能是Mach</span></span><br><span class="line">SIGTRAP, <span class="comment">// 由断点指令或其它trap指令产生，一般出现在debug调试时</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>EXC_BAD_ACCESS</code>：is a Mach exception sent by the kernel to your application when you try to access memory that is not mapped for your application(访问没有映射到你APP的内存时). If not handled at the Mach level, it will be translated into a SIGBUS or SIGSEGV BSD signal.(如果没有在mach级别处理，就会被转换成这两种信号)      ——  Matt大神的<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.cocoawithlove.com/2010/05/handling-unhandled-exceptions-and.html">回答</a></li>
<li>SIGABRT is a BSD signal sent by an application to itself when an NSException or obj_exception_throw is not caught.</li>
</ul>
<p>Mach exception和Signal转换：</p>
<img src="/images/crash/mach-bsd.png" alt="mach-bsd" style="zoom:90%;" />

<h2 id="3-4-Crash的收集【实现】"><a href="#3-4-Crash的收集【实现】" class="headerlink" title="3.4 Crash的收集【实现】"></a>3.4 Crash的收集【实现】</h2><p>如上述所说，通过捕获Mach异常或者Unix信号都可以抓到crash事件，于是总结起来实现方案就一共有3种。</p>
<p><strong>Q: 哪种方式更好呢？</strong></p>
<p>优选Mach异常，因为Mach异常处理会先于Unix信号处理发生，如果Mach异常的handler让程序exit了，那么Unix信号就永远不会到达这个进程了。</p>
<p>另外，不是所有的 “Mach异常” 类型都映射到了 “UNIX信号”。 如 EXC_GUARD 。在苹果开源的 xnu 源码中可以看到这点。</p>
<h3 id="3-4-1-Mach异常方式"><a href="#3-4-1-Mach异常方式" class="headerlink" title="3.4.1 Mach异常方式"></a>3.4.1 Mach异常方式</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> mach_port_t server_port;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *exc_handler(<span class="keyword">void</span> *ignored);</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否 Xcode 联调</span></span><br><span class="line"><span class="keyword">bool</span> ksdebug_isBeingTraced(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> kinfo_proc procInfo;</span><br><span class="line">    size_t structSize = <span class="keyword">sizeof</span>(procInfo);</span><br><span class="line">    <span class="keyword">int</span> mib[] = &#123;<span class="built_in">CTL_KERN</span>, KERN_PROC, KERN_PROC_PID, getpid()&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(sysctl(mib, <span class="keyword">sizeof</span>(mib)/<span class="keyword">sizeof</span>(*mib), &amp;procInfo, &amp;structSize, <span class="literal">NULL</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (procInfo.kp_proc.p_flag &amp; P_TRACED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXC_UNIX_BAD_SYSCALL 0x10000 <span class="comment">/* SIGSYS */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXC_UNIX_BAD_PIPE    0x10001 <span class="comment">/* SIGPIPE */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXC_UNIX_ABORT       0x10002 <span class="comment">/* SIGABRT */</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> signalForMachException(exception_type_t exception, mach_exception_code_t code)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span>(exception)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> EXC_ARITHMETIC:</span><br><span class="line">            <span class="keyword">return</span> SIGFPE;</span><br><span class="line">        <span class="keyword">case</span> EXC_BAD_ACCESS:</span><br><span class="line">            <span class="keyword">return</span> code == KERN_INVALID_ADDRESS ? SIGSEGV : SIGBUS;</span><br><span class="line">        <span class="keyword">case</span> EXC_BAD_INSTRUCTION:</span><br><span class="line">            <span class="keyword">return</span> SIGILL;</span><br><span class="line">        <span class="keyword">case</span> EXC_BREAKPOINT:</span><br><span class="line">            <span class="keyword">return</span> SIGTRAP;</span><br><span class="line">        <span class="keyword">case</span> EXC_EMULATION:</span><br><span class="line">            <span class="keyword">return</span> SIGEMT;</span><br><span class="line">        <span class="keyword">case</span> EXC_SOFTWARE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">switch</span> (code)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> EXC_UNIX_BAD_SYSCALL:</span><br><span class="line">                    <span class="keyword">return</span> SIGSYS;</span><br><span class="line">                <span class="keyword">case</span> EXC_UNIX_BAD_PIPE:</span><br><span class="line">                    <span class="keyword">return</span> SIGPIPE;</span><br><span class="line">                <span class="keyword">case</span> EXC_UNIX_ABORT:</span><br><span class="line">                    <span class="keyword">return</span> SIGABRT;</span><br><span class="line">                <span class="keyword">case</span> EXC_SOFT_SIGNAL:</span><br><span class="line">                    <span class="keyword">return</span> SIGKILL;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *stringForMachException(exception_type_t exception) &#123;</span><br><span class="line">    <span class="keyword">switch</span>(exception)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> EXC_ARITHMETIC:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_ARITHMETIC&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> EXC_BAD_ACCESS:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_BAD_ACCESS&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> EXC_BAD_INSTRUCTION:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_BAD_INSTRUCTION&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> EXC_BREAKPOINT:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_BREAKPOINT&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> EXC_EMULATION:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_EMULATION&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> EXC_SOFTWARE:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">@&quot;EXC_SOFTWARE&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> installExceptionHandler() &#123;</span><br><span class="line">    <span class="keyword">if</span> (ksdebug_isBeingTraced()) &#123;</span><br><span class="line">        <span class="comment">// 当前正在调试状态, 不启动 mach 监听</span></span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    kern_return_t kr = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;server_port);</span><br><span class="line">    assert(kr == KERN_SUCCESS);</span><br><span class="line">    </span><br><span class="line">    kern_return_t rc = <span class="number">0</span>;</span><br><span class="line">    exception_mask_t excMask = EXC_MASK_BAD_ACCESS |</span><br><span class="line">    EXC_MASK_BAD_INSTRUCTION |</span><br><span class="line">    EXC_MASK_ARITHMETIC |</span><br><span class="line">    EXC_MASK_SOFTWARE |</span><br><span class="line">    EXC_MASK_BREAKPOINT;</span><br><span class="line">    </span><br><span class="line">    rc = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;server_port);</span><br><span class="line">    <span class="keyword">if</span> (rc != KERN_SUCCESS) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;-------&gt;Fail to allocate exception port\\\\\\\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rc = mach_port_insert_right(mach_task_self(), server_port, server_port, MACH_MSG_TYPE_MAKE_SEND);</span><br><span class="line">    <span class="keyword">if</span> (rc != KERN_SUCCESS) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;--------&gt;Fail to insert right&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rc = thread_set_exception_ports(mach_thread_self(), excMask, server_port, EXCEPTION_DEFAULT, MACHINE_THREAD_STATE);</span><br><span class="line">    <span class="keyword">if</span> (rc != KERN_SUCCESS) &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">&quot;--------&gt;Fail to  set exception\\\\\\\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//建立监听线程</span></span><br><span class="line">    pthread_t thread;</span><br><span class="line">    pthread_create(&amp;thread, <span class="literal">NULL</span>, exc_handler, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *exc_handler(<span class="keyword">void</span> *ignored) &#123;</span><br><span class="line">    <span class="comment">// Exception handler – runs a message loop. Refactored into a standalone function</span></span><br><span class="line">    <span class="comment">// so as to allow easy insertion into a thread (can be in same program or different)</span></span><br><span class="line">    mach_msg_return_t rc;</span><br><span class="line">    fprintf(stderr, <span class="string">&quot;Exc handler listening\\\\\\\\n&quot;</span>);</span><br><span class="line">    <span class="comment">// The exception message, straight from mach/exc.defs (following MIG processing) // copied here for ease of reference.</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">        mach_msg_header_t Head;</span><br><span class="line">        <span class="comment">/* start of the kernel processed data */</span></span><br><span class="line">        mach_msg_body_t msgh_body;</span><br><span class="line">        mach_msg_port_descriptor_t thread;</span><br><span class="line">        mach_msg_port_descriptor_t task;</span><br><span class="line">        <span class="comment">/* end of the kernel processed data */</span></span><br><span class="line">        NDR_record_t NDR;</span><br><span class="line">        exception_type_t exception;</span><br><span class="line">        mach_msg_type_number_t codeCnt;</span><br><span class="line">        integer_t code[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> flavor;</span><br><span class="line">        mach_msg_type_number_t old_stateCnt;</span><br><span class="line">        natural_t old_state[<span class="number">144</span>];</span><br><span class="line">    &#125; Request;</span><br><span class="line">    </span><br><span class="line">    Request exc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> rep_msg &#123;</span><br><span class="line">        mach_msg_header_t Head;</span><br><span class="line">        NDR_record_t NDR;</span><br><span class="line">        kern_return_t RetCode;</span><br><span class="line">    &#125; rep_msg;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">        <span class="comment">// Message Loop: Block indefinitely until we get a message, which has to be</span></span><br><span class="line">        <span class="comment">// 这里会阻塞，直到接收到exception message，或者线程被中断。</span></span><br><span class="line">        <span class="comment">// an exception message (nothing else arrives on an exception port)</span></span><br><span class="line">        rc = mach_msg( &amp;exc.Head,</span><br><span class="line">                      MACH_RCV_MSG|MACH_RCV_LARGE,</span><br><span class="line">                      <span class="number">0</span>,</span><br><span class="line">                      <span class="keyword">sizeof</span>(Request),</span><br><span class="line">                      server_port, <span class="comment">// Remember this was global – that&#x27;s why.</span></span><br><span class="line">                      MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                      MACH_PORT_NULL);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(rc != MACH_MSG_SUCCESS) &#123;</span><br><span class="line">            <span class="comment">/*... */</span></span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Mach Exception 类型</span></span><br><span class="line">        <span class="built_in">NSMutableString</span> *crashInfo = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@&quot;mach exception:%@ %@\n\n&quot;</span>,stringForMachException(exc.exception), stringForSignal(signalForMachException(exc.exception, exc.code[<span class="number">0</span>]))];</span><br><span class="line">        </span><br><span class="line">        rep_msg.Head = exc.Head;</span><br><span class="line">        rep_msg.NDR = exc.NDR;</span><br><span class="line">        rep_msg.RetCode = KERN_FAILURE;</span><br><span class="line">        </span><br><span class="line">        kern_return_t result;</span><br><span class="line">        <span class="keyword">if</span> (rc == MACH_MSG_SUCCESS) &#123;</span><br><span class="line">            result = mach_msg(&amp;rep_msg.Head,</span><br><span class="line">                              MACH_SEND_MSG,</span><br><span class="line">                              <span class="keyword">sizeof</span> (rep_msg),</span><br><span class="line">                              <span class="number">0</span>,</span><br><span class="line">                              MACH_PORT_NULL,</span><br><span class="line">                              MACH_MSG_TIMEOUT_NONE,</span><br><span class="line">                              MACH_PORT_NULL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//移除其他 Crash 监听, 防止死锁</span></span><br><span class="line">        <span class="built_in">NSSetUncaughtExceptionHandler</span>(<span class="literal">NULL</span>);</span><br><span class="line">        signal(SIGHUP, SIG_DFL);</span><br><span class="line">        signal(SIGINT, SIG_DFL);</span><br><span class="line">        signal(SIGQUIT, SIG_DFL);</span><br><span class="line">        signal(SIGABRT, SIG_DFL);</span><br><span class="line">        signal(SIGILL, SIG_DFL);</span><br><span class="line">        signal(SIGSEGV, SIG_DFL);</span><br><span class="line">        signal(SIGFPE, SIG_DFL);</span><br><span class="line">        signal(SIGBUS, SIG_DFL);</span><br><span class="line">        signal(SIGPIPE, SIG_DFL);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>监听 Mach 异常需要注意:</p>
<ul>
<li>避免在 Xcode 联调时监听。原因是我们监听了<code>EXC_BREAKPOINT</code>这类型的<code>Exception</code>，一旦启动 app 联调后， 会立即触发<code>EXC_BREAKPOINT</code>。而这段代码处理完后，会进入下一个循环等待，可主线程还等着消息处理结果，这就造成等待死锁。</li>
</ul>
<h3 id="3-4-2-Unix信号方式"><a href="#3-4-2-Unix信号方式" class="headerlink" title="3.4.2 Unix信号方式"></a>3.4.2 Unix信号方式</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;NWCrashSignalExceptionHandler.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;execinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NWCrashTool.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(*SignalHandler)(<span class="keyword">int</span> signal, siginfo_t *info, <span class="keyword">void</span> *context);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> SignalHandler previousABRTSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousBUSSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousFPESignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousILLSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousPIPESignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousSEGVSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousSYSSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> SignalHandler previousTRAPSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NWCrashSignalExceptionHandler</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)registerHandler &#123;</span><br><span class="line">    <span class="comment">// 将先前别人注册的handler取出并备份</span></span><br><span class="line">    [<span class="keyword">self</span> backupOriginalHandler];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> signalRegister];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)backupOriginalHandler &#123;</span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_abrt;</span><br><span class="line">    sigaction(SIGABRT, <span class="literal">NULL</span>, &amp;old_action_abrt);</span><br><span class="line">    <span class="keyword">if</span> (old_action_abrt.sa_sigaction) &#123;</span><br><span class="line">        previousABRTSignalHandler = old_action_abrt.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_bus;</span><br><span class="line">    sigaction(SIGBUS, <span class="literal">NULL</span>, &amp;old_action_bus);</span><br><span class="line">    <span class="keyword">if</span> (old_action_bus.sa_sigaction) &#123;</span><br><span class="line">        previousBUSSignalHandler = old_action_bus.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_fpe;</span><br><span class="line">    sigaction(SIGFPE, <span class="literal">NULL</span>, &amp;old_action_fpe);</span><br><span class="line">    <span class="keyword">if</span> (old_action_fpe.sa_sigaction) &#123;</span><br><span class="line">        previousFPESignalHandler = old_action_fpe.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_ill;</span><br><span class="line">    sigaction(SIGILL, <span class="literal">NULL</span>, &amp;old_action_ill);</span><br><span class="line">    <span class="keyword">if</span> (old_action_ill.sa_sigaction) &#123;</span><br><span class="line">        previousILLSignalHandler = old_action_ill.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_pipe;</span><br><span class="line">    sigaction(SIGPIPE, <span class="literal">NULL</span>, &amp;old_action_pipe);</span><br><span class="line">    <span class="keyword">if</span> (old_action_pipe.sa_sigaction) &#123;</span><br><span class="line">        previousPIPESignalHandler = old_action_pipe.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_segv;</span><br><span class="line">    sigaction(SIGSEGV, <span class="literal">NULL</span>, &amp;old_action_segv);</span><br><span class="line">    <span class="keyword">if</span> (old_action_segv.sa_sigaction) &#123;</span><br><span class="line">        previousSEGVSignalHandler = old_action_segv.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_sys;</span><br><span class="line">    sigaction(SIGSYS, <span class="literal">NULL</span>, &amp;old_action_sys);</span><br><span class="line">    <span class="keyword">if</span> (old_action_sys.sa_sigaction) &#123;</span><br><span class="line">        previousSYSSignalHandler = old_action_sys.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> sigaction old_action_trap;</span><br><span class="line">    sigaction(SIGTRAP, <span class="literal">NULL</span>, &amp;old_action_trap);</span><br><span class="line">    <span class="keyword">if</span> (old_action_trap.sa_sigaction) &#123;</span><br><span class="line">        previousTRAPSignalHandler = old_action_trap.sa_sigaction;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)signalRegister &#123;</span><br><span class="line">    NWSignalRegister(SIGABRT);</span><br><span class="line">    NWSignalRegister(SIGBUS);</span><br><span class="line">    NWSignalRegister(SIGFPE);</span><br><span class="line">    NWSignalRegister(SIGILL);</span><br><span class="line">    NWSignalRegister(SIGPIPE);</span><br><span class="line">    NWSignalRegister(SIGSEGV);</span><br><span class="line">    NWSignalRegister(SIGSYS);</span><br><span class="line">    NWSignalRegister(SIGTRAP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Private</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark Register Signal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> NWSignalRegister(<span class="keyword">int</span> signal) &#123;</span><br><span class="line">    <span class="keyword">struct</span> sigaction action;</span><br><span class="line">    action.sa_sigaction = NWSignalHandler;</span><br><span class="line">    action.sa_flags = SA_NODEFER | SA_SIGINFO;</span><br><span class="line">    sigemptyset(&amp;action.sa_mask);</span><br><span class="line">    sigaction(signal, &amp;action, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark SignalCrash Handler</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> NWSignalHandler(<span class="keyword">int</span> signal, siginfo_t* info, <span class="keyword">void</span>* context) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *mstr = [[<span class="built_in">NSMutableString</span> alloc] init];</span><br><span class="line">    [mstr appendString:<span class="string">@&quot;Signal Exception:\n&quot;</span>];</span><br><span class="line">    [mstr appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;Signal %@ was raised.\n&quot;</span>, signalName(signal)]];</span><br><span class="line">    [mstr appendString:<span class="string">@&quot;Call Stack:\n&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里过滤掉第一行日志</span></span><br><span class="line">    <span class="comment">// 因为注册了信号崩溃回调方法，系统会来调用，将记录在调用堆栈上，因此此行日志需要过滤掉</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> index = <span class="number">1</span>; index &lt; <span class="built_in">NSThread</span>.callStackSymbols.count; index++) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *str = [<span class="built_in">NSThread</span>.callStackSymbols objectAtIndex:index];</span><br><span class="line">        [mstr appendString:[str stringByAppendingString:<span class="string">@&quot;\n&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [mstr appendString:<span class="string">@&quot;threadInfo:\n&quot;</span>];</span><br><span class="line">    [mstr appendString:[[<span class="built_in">NSThread</span> currentThread] description]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存崩溃日志到沙盒cache目录</span></span><br><span class="line">    [NWCrashTool saveCrashLog:[<span class="built_in">NSString</span> stringWithString:mstr] fileName:<span class="string">@&quot;Crash(Signal)&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    NWClearSignalRegister();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用之前崩溃的回调函数</span></span><br><span class="line">    <span class="comment">// 在自己handler处理完后自觉把别人的handler注册回去，规规矩矩的传递</span></span><br><span class="line">    previousSignalHandler(signal, info, context);</span><br><span class="line">    </span><br><span class="line">    kill(getpid(), SIGKILL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark Signal To Name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *signalName(<span class="keyword">int</span> signal) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *signalName;</span><br><span class="line">    <span class="keyword">switch</span> (signal) &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGABRT:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGABRT&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGBUS:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGBUS&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGFPE:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGFPE&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGILL:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGILL&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGPIPE:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGPIPE&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGSEGV:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGSEGV&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGSYS:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGSYS&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGTRAP:</span><br><span class="line">            signalName = <span class="string">@&quot;SIGTRAP&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> signalName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark Previous Signal</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> previousSignalHandler(<span class="keyword">int</span> signal, siginfo_t *info, <span class="keyword">void</span> *context) &#123;</span><br><span class="line">    SignalHandler previousSignalHandler = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">switch</span> (signal) &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGABRT:</span><br><span class="line">            previousSignalHandler = previousABRTSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGBUS:</span><br><span class="line">            previousSignalHandler = previousBUSSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGFPE:</span><br><span class="line">            previousSignalHandler = previousFPESignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGILL:</span><br><span class="line">            previousSignalHandler = previousILLSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGPIPE:</span><br><span class="line">            previousSignalHandler = previousPIPESignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGSEGV:</span><br><span class="line">            previousSignalHandler = previousSEGVSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGSYS:</span><br><span class="line">            previousSignalHandler = previousSYSSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGTRAP:</span><br><span class="line">            previousSignalHandler = previousTRAPSignalHandler;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (previousSignalHandler) &#123;</span><br><span class="line">        previousSignalHandler(signal, info, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark Clear</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> NWClearSignalRegister() &#123;</span><br><span class="line">    signal(SIGSEGV,SIG_DFL);</span><br><span class="line">    signal(SIGFPE,SIG_DFL);</span><br><span class="line">    signal(SIGBUS,SIG_DFL);</span><br><span class="line">    signal(SIGTRAP,SIG_DFL);</span><br><span class="line">    signal(SIGABRT,SIG_DFL);</span><br><span class="line">    signal(SIGILL,SIG_DFL);</span><br><span class="line">    signal(SIGPIPE,SIG_DFL);</span><br><span class="line">    signal(SIGSYS,SIG_DFL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="3-4-3-Mach异常-Unix信号方式"><a href="#3-4-3-Mach异常-Unix信号方式" class="headerlink" title="3.4.3 Mach异常+Unix信号方式"></a>3.4.3 Mach异常+Unix信号方式</h3><p>Github上多数开源项目都采用的这种方式。</p>
<p>为什么不能只监听 Mach Exception？网上所说的原因都是因为 EXC_CRASH 不能通过 Mach 监控来抓捕。即使在优选捕获Mach异常的情况下，也放弃捕获EXC_CRASH异常，而选择捕获与之对应的SIGABRT信号。</p>
<p>著名开源项目<a target="_blank" rel="noopener" href="https://github.com/plausiblelabs/plcrashreporter">plcrashreporter</a>在代码注释中给出了详细的解释：</p>
<blockquote>
<p>We still need to use signal handlers to catch SIGABRT in-process. The kernel sends an EXC_CRASH mach exception to denote SIGABRT termination. In that case, catching the Mach exception in-process leads to process deadlock in an uninterruptable wait. Thus, we fall back on BSD signal handlers for SIGABRT, and do not register for EXC_CRASH.</p>
<p>我们仍然需要使用信号处理程序来捕获进程内的SIGABRT。内核发送一个EXC_CRASH mach异常来表示SIGABRT终止。在这种情况下，在进程中捕获Mach异常会导致不可中断等待中的进程死锁。因此，我们对SIGABRT使用BSD信号处理程序，而不注册EXC_CRASH。</p>
</blockquote>
<h1 id="四、捕获-—-应用级异常"><a href="#四、捕获-—-应用级异常" class="headerlink" title="四、捕获 — 应用级异常"></a>四、捕获 — 应用级异常</h1><p>对于应用级异常，还需要单独的特殊处理。</p>
<h2 id="4-1-NSException"><a href="#4-1-NSException" class="headerlink" title="4.1 NSException"></a>4.1 NSException</h2><h3 id="4-1-1-为何要实现-NSException-监听"><a href="#4-1-1-为何要实现-NSException-监听" class="headerlink" title="4.1.1 为何要实现 NSException 监听"></a>4.1.1 为何要实现 NSException 监听</h3><p>按照我们前面所说，通过 Mach/Signal 的方式我们已经可以监听绝大部分崩溃场景了，那为何我们还要实现NSException 监听呢？</p>
<p>原因是：对于Objective-C异常，一般可通过try catch来捕获。未被<code>try catch</code> 的 NSException，会发出 <code>kill</code> 或 <code>pthread_kill</code> 信号-&gt; Mach异常-&gt; Unix信号（SIGABRT），但是如果通过捕获<code>SIGABRT</code>信号的方式，来抓取异常，那么在处理收集信息时，<strong>获取当前堆栈时获取不到</strong>，所以需要采用<code>NSSetUncaughtExceptionHandler</code> 单独处理。</p>
<h3 id="4-1-2-常见的-NSException-及其场景"><a href="#4-1-2-常见的-NSException-及其场景" class="headerlink" title="4.1.2 常见的 NSException 及其场景"></a>4.1.2 常见的 NSException 及其场景</h3><p><code>NSException.h</code> 常见的几种异常名称：</p>
<ul>
<li>NSInvalidArgumentException<ul>
<li>非法参数异常(NSInvalidArgumentException)是 Objective – C 代码最常出现的错误，所以平时在写代码的时候，需要多加注意，加强对参数的检查，避免传入非法参数导致异常，其中尤以<strong>nil参数</strong>为甚。</li>
<li><code>unrecognized selector send to instance</code>.</li>
</ul>
</li>
<li>NSRangeException<ul>
<li>越界异常(NSRangeException)也是比较常出现的异常。</li>
</ul>
</li>
<li>NSGenericException<ul>
<li>NSGenericException这个异常最容易出现在foreach操作中，在for in循环中如果修改所遍历的数组，无论你是add或remove，都会出错。“for in” 内部遍历使用了类似 Iterator进行迭代遍历，一旦元素变动，之前的元素全部被失效，所以在foreach的循环当中，最好不要去进行元素的修改动作，若需要修改，循环改为for遍历，由于内部机制不同，不会产生修改后结果失效的问题。</li>
</ul>
</li>
<li>NSInternalInconsistencyException<ul>
<li>不一致导致出现的异常。比如NSDictionary当做NSMutableDictionary来使用，从他们内部的机理来说，就会产生一些错误。</li>
</ul>
</li>
<li>NSFileHandleOperationException<ul>
<li>处理文件时的一些异常，最常见的还是存储空间不足的问题，比如应用频繁的保存文档，缓存资料或者处理比较大的数据。所以在文件处理里，需要考虑到手机存储空间的问题。</li>
</ul>
</li>
<li>NSMallocException<ul>
<li>内存分配异常。这也是内存不足的问题，无法分配足够的内存空间。</li>
</ul>
</li>
<li>非主线程刷新UI</li>
<li>KVO引起的崩溃：没有正确的添加、移除观察者。</li>
</ul>
<h3 id="4-1-3-NSException类示例"><a href="#4-1-3-NSException类示例" class="headerlink" title="4.1.3 NSException类示例"></a>4.1.3 NSException类示例</h3><p>以iOS开发常见的 NSException 为例，你是否见过崩溃在main函数的crash日志，但是函数栈里面没有你的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Thread <span class="number">0</span> Crashed:</span><br><span class="line"><span class="number">0</span>       libsystem_kernel.dylib          <span class="number">0x3a61757c</span>   __semwait_signal_nocancel + <span class="number">0x18</span></span><br><span class="line"><span class="number">1</span>       libsystem_c.dylib               <span class="number">0x3a592a7c</span>   nanosleep$NOCANCEL + <span class="number">0xa0</span></span><br><span class="line"><span class="number">2</span>       libsystem_c.dylib               <span class="number">0x3a5adede</span>   usleep$NOCANCEL + <span class="number">0x2e</span></span><br><span class="line"><span class="number">3</span>       libsystem_c.dylib               <span class="number">0x3a5c7fe0</span>   <span class="built_in">abort</span> + <span class="number">0x50</span></span><br><span class="line"><span class="number">4</span>       libc++abi.dylib                 <span class="number">0x398f6cd2</span>   abort_message + <span class="number">0x46</span></span><br><span class="line"><span class="number">5</span>       libc++abi.dylib                 <span class="number">0x3990f6e0</span>   default_terminate_handler() + <span class="number">0xf8</span></span><br><span class="line"><span class="number">6</span>       libobjc.A.dylib                 <span class="number">0x3a054f62</span>   _objc_terminate() + <span class="number">0xbe</span></span><br><span class="line"><span class="number">7</span>       libc++abi.dylib                 <span class="number">0x3990d1c4</span>   <span class="built_in">std</span>::__terminate(<span class="keyword">void</span> (*)()) + <span class="number">0x4c</span></span><br><span class="line"><span class="number">8</span>       libc++abi.dylib                 <span class="number">0x3990cd28</span>   __cxa_rethrow + <span class="number">0x60</span></span><br><span class="line"><span class="number">9</span>       libobjc.A.dylib                 <span class="number">0x3a054e12</span>   objc_exception_rethrow + <span class="number">0x26</span></span><br><span class="line"><span class="number">10</span>      CoreFoundation                  <span class="number">0x2f7d7f30</span>   CFRunLoopRunSpecific + <span class="number">0x27c</span></span><br><span class="line"><span class="number">11</span>      CoreFoundation                  <span class="number">0x2f7d7c9e</span>   CFRunLoopRunInMode + <span class="number">0x66</span></span><br><span class="line"><span class="number">12</span>      GraphicsServices                <span class="number">0x346dd65e</span>   GSEventRunModal + <span class="number">0x86</span></span><br><span class="line"><span class="number">13</span>      UIKit                           <span class="number">0x32124148</span>   UIApplicationMain + <span class="number">0x46c</span></span><br><span class="line"><span class="number">14</span>      XXXXXX                          <span class="number">0x0003b1f2</span>   main + <span class="number">0x1f2</span></span><br><span class="line"><span class="number">15</span>      libdyld.dylib                   <span class="number">0x3a561ab4</span>   start + <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>可以看出是因为某个NSException导致程序Crash的，只有拿到这个NSException，获取它的reason，name，callStackSymbols信息才能确定出问题的程序位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* NSException Class Reference */</span></span><br><span class="line">@property(readonly, copy) NSString *name;  </span><br><span class="line">@property(readonly, copy) NSString *reason;</span><br><span class="line">@property(readonly, copy) NSArray *callStackSymbols;</span><br><span class="line">@property(readonly, copy) NSArray *callStackReturnAddresses;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-4-NSException的捕获"><a href="#4-1-4-NSException的捕获" class="headerlink" title="4.1.4 NSException的捕获"></a>4.1.4 NSException的捕获</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录之前的崩溃回调函数</span></span><br><span class="line"><span class="keyword">static</span> NSUncaughtExceptionHandler *previousUncaughtExceptionHandler = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">my_uncaught_exception_handler</span> <span class="params">(NSException *exception)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 异常的堆栈信息</span></span><br><span class="line">    NSArray * stackArray = [exception callStackSymbols];</span><br><span class="line">    <span class="comment">// 出现异常的原因</span></span><br><span class="line">    NSString * reason = [exception reason];</span><br><span class="line">    <span class="comment">// 异常名称</span></span><br><span class="line">    NSString * name = [exception name];</span><br><span class="line">    </span><br><span class="line">    NSString * exceptionInfo = [NSString stringWithFormat:@<span class="string">&quot;========uncaughtException异常错误报告========\nname:%@\nreason:\n%@\ncallStackSymbols:\n%@&quot;</span>, name, reason, [stackArray componentsJoinedByString:@<span class="string">&quot;\n&quot;</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保存崩溃日志到沙盒cache目录</span></span><br><span class="line">    [NWCrashTool saveCrashLog:exceptionInfo fileName:@<span class="string">&quot;Crash(Uncaught)&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//在自己handler处理完后自觉把别人的handler注册回去，规规矩矩的传递</span></span><br><span class="line">    <span class="keyword">if</span> (previousUncaughtExceptionHandler) &#123;</span><br><span class="line">        previousUncaughtExceptionHandler(exception);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 杀掉程序，这样可以防止同时抛出的SIGABRT被SignalException捕获</span></span><br><span class="line">    kill(getpid(), SIGKILL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)registerHandler &#123;</span><br><span class="line">    <span class="comment">//将先前别人注册的handler取出并备份</span></span><br><span class="line">    previousUncaughtExceptionHandler = NSGetUncaughtExceptionHandler();</span><br><span class="line">  </span><br><span class="line">    NSSetUncaughtExceptionHandler(&amp;my_uncaught_exception_handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将拿到的NSException细节写入Crash日志，精准的定位出错程序位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Application Specific Information:</span><br><span class="line">*** Terminating app due to uncaught exception &#x27;NSUnknownKeyException&#x27;, reason: &#x27;[ setValue:forUndefinedKey:]: this class is not key value coding-compliant for the key key.&#x27;</span><br><span class="line">Last Exception Backtrace:</span><br><span class="line"><span class="number">0</span> CoreFoundation <span class="number">0x2f8a3f7e</span>     __exceptionPreprocess + <span class="number">0x7e</span></span><br><span class="line"><span class="number">1</span> libobjc.A.dylib <span class="number">0x3a054cc</span>     objc_exception_throw + <span class="number">0x22</span></span><br><span class="line"><span class="number">2</span> CoreFoundation <span class="number">0x2f8a3c94</span>     -[NSException raise] + <span class="number">0x4</span></span><br><span class="line"><span class="number">3</span> Foundation <span class="number">0x301e8f1e</span>         -[NSObject(NSKeyValueCoding) setValue:forKey:] + <span class="number">0xc6</span></span><br><span class="line"><span class="number">4</span> DemoCrash <span class="number">0x00085306</span>          -[ViewController crashMethod] + <span class="number">0x6e</span></span><br><span class="line"><span class="number">5</span> DemoCrash <span class="number">0x00084ecc</span>          main + <span class="number">0x1cc</span></span><br><span class="line"><span class="number">6</span> DemoCrash <span class="number">0x00084cf8</span>          start + <span class="number">0x24</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-5-注意点"><a href="#4-1-5-注意点" class="headerlink" title="4.1.5 注意点"></a>4.1.5 注意点</h3><p><strong>Q: 是不是收到了大量crash在main函数却没有NSException信息的日志，就代表自己集成的Crash日志收集服务没有注册NSUncaughtExceptionHandler呢？</strong></p>
<p>不一定，还有另外一种可能，就是被同时存在的其他Crash日志收集服务给坑了。</p>
<p><strong>Q: 未设置NSSetUncaughtExceptionHandler的NSException最后会转成Unix信号吗？</strong></p>
<p>无论设置NSSetUncaughtExceptionHandler与否，只要未被try catch，最终都会被转成Unix信号，只不过设置了无法在其ExceptionHandler中无法获得最终发送的Unix信号类型</p>
<h2 id="3-2-ObjC野指针类的Crash"><a href="#3-2-ObjC野指针类的Crash" class="headerlink" title="3.2 ObjC野指针类的Crash"></a>3.2 ObjC野指针类的Crash</h2><p>收集Crash日志这个步骤没有问题的情况下，还是有很多全系统栈的日志的情况，没有自己一行代码，分析起来十分棘手，ObjC野指针类的Crash正是如此，这里推荐几篇好文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1070505">如何定位Obj-C野指针随机Crash(一)：先提高野指针Crash率</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1070512">如何定位Obj-C野指针随机Crash(二)：让非必现Crash变成必现</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1070528">如何定位Obj-C野指针随机Crash(三)：加点黑科技让Crash自报家门</a></li>
<li><a target="_blank" rel="noopener" href="http://www.sealiesoftware.com/blog/archive/2008/09/22/objc_explain_So_you_crashed_in_objc_msgSend.html">分析objc_msgSend()处崩溃的小技巧</a></li>
</ul>
<p>除此之外，在Crash日志中补充记录一些额外信息可以辅助定位，如切面标记线程出处、队列出处，记录用户操作轨迹等等……</p>
<h2 id="4-3-C-exceptions"><a href="#4-3-C-exceptions" class="headerlink" title="4.3 C++ exceptions"></a>4.3 C++ exceptions</h2><p>实质上C++异常也可以通过 Mach 异常的方式处理。只是在细节处理上仍多有区别。</p>
<h3 id="4-3-1-为什么要捕捉-C-异常"><a href="#4-3-1-为什么要捕捉-C-异常" class="headerlink" title="4.3.1 为什么要捕捉 C++异常"></a>4.3.1 为什么要捕捉 C++异常</h3><p>在OSX中，会通过对话框展示异常给用户，但在iOS中，只是重新抛出异常。系统在捕捉到C++异常后，如果能够将此C++异常转换为OC异常，则抛出OC异常处理机制；如果不能转换，则会立刻调用__cxa_throw重新抛出异常。</p>
<p>当系统在RunLoop捕捉到的C++异常时，此时的调用堆栈是异常发生时的堆栈，但当系统在不能转换为OC异常时调用__cxa_throw时，上层捕捉此再抛出的异常获取到的调用堆栈是RunLoop异常处理函数的堆栈，导致原始异常调用堆栈丢失。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thread <span class="number">0</span> Crashed:: Dispatch queue: com.apple.main-thread</span><br><span class="line"><span class="number">0</span>   libsystem_kernel.dylib          <span class="number">0x00007fff93ef8d46</span> __kill + <span class="number">10</span></span><br><span class="line"><span class="number">1</span>   libsystem_c.dylib               <span class="number">0x00007fff89968df0</span> abort + <span class="number">177</span></span><br><span class="line"><span class="number">2</span>   libc++abi.dylib                 <span class="number">0x00007fff8beb5a17</span> abort_message + <span class="number">257</span></span><br><span class="line"><span class="number">3</span>   libc++abi.dylib                 <span class="number">0x00007fff8beb33c6</span> default_terminate() + <span class="number">28</span></span><br><span class="line"><span class="number">4</span>   libobjc.A.dylib                 <span class="number">0x00007fff8a196887</span> _objc_terminate() + <span class="number">111</span></span><br><span class="line"><span class="number">5</span>   libc++abi.dylib                 <span class="number">0x00007fff8beb33f5</span> safe_handler_caller(<span class="keyword">void</span> (*)()) + <span class="number">8</span></span><br><span class="line"><span class="number">6</span>   libc++abi.dylib                 <span class="number">0x00007fff8beb3450</span> std::terminate() + <span class="number">16</span></span><br><span class="line"><span class="number">7</span>   libc++abi.dylib                 <span class="number">0x00007fff8beb45b7</span> __cxa_throw + <span class="number">111</span></span><br><span class="line"><span class="number">8</span>   test                            <span class="number">0x0000000102999f3b</span> main + <span class="number">75</span></span><br><span class="line"><span class="number">9</span>   libdyld.dylib                   <span class="number">0x00007fff8e4ab7e1</span> start + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-如何捕捉C-异常"><a href="#4-3-2-如何捕捉C-异常" class="headerlink" title="4.3.2 如何捕捉C++异常"></a>4.3.2 如何捕捉C++异常</h3><p>C++ exceptions使用系统封装好的函数<code>std::set_terminate(CPPExceptionTerminate)</code>来设置回调。逻辑类似NSException的处理。</p>
<ol>
<li><p>设置异常处理函数。调用std::set_terminate设置新的全局终止处理函数并保存旧的函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g_originalTerminateHandler = std::<span class="built_in">set_terminate</span>(CPPExceptionTerminate);</span><br></pre></td></tr></table></figure></li>
<li><p>重写 <code>__cxa_throw</code>。在异常发生时，会先进入此重写函数，应该先获取调用堆栈并存储；再调用原始的<code>__cxa_throw</code> 函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __cxa_throw(<span class="keyword">void</span>* thrown_exception, std::type_info* tinfo, <span class="built_in"><span class="keyword">void</span></span> (*dest)(<span class="keyword">void</span>*))</span><br></pre></td></tr></table></figure></li>
<li><p>异常处理函数。__cxa_throw往后执行，进入set_terminate设置的异常处理函数。判断如果检测是OC异常，则什么也不做，让OC异常机制处理；否则获取异常信息。</p>
</li>
</ol>
<h2 id="4-4-Swift-exception"><a href="#4-4-Swift-exception" class="headerlink" title="4.4 Swift exception"></a>4.4 Swift exception</h2><p>Swift 下的 exception 的处理过程和 NSException 差别很大。</p>
<ul>
<li><p>swift通常都是通过对应的signal来捕获crash。对于swift的崩溃捕获，Apple的<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://developer.apple.com/library/content/technotes/tn2151/_index.html">文档</a>中有描述说需要通过<code>SIGTRAP</code>信号捕获强转失败，及非可选的nil值导致的崩溃.具体描述如下：</p>
<blockquote>
<p>Trace Trap[EXC_BREAKPOINT // SIGTRAP]</p>
<p>类似于异常退出，此异常旨在使附加的调试器有机会在其执行中的特定点中断进程。您可以使用该__builtin_trap()函数从您自己的代码触发此异常。如果没有附加调试器，则该过程将终止并生成崩溃报告。</p>
<p>较低级的库（例如，libdispatch）会在遇到致命错误时捕获进程。有关错误的其他信息可以在崩溃报告的“ 附加诊断信息”部分或设备的控制台中找到。</p>
<p>如果在运行时遇到意外情况，Swift代码将以此异常类型终止，例如：</p>
<ol>
<li>具有nil值的非可选类型</li>
<li>一个失败的强制类型转换</li>
</ol>
</blockquote>
</li>
<li><p>对于swift还有一种崩溃需要捕获(Intel处理器)，为保险起见，也需要将信号<code>SIGILL</code>进行注册，Apple同样对其中做了描述</p>
<blockquote>
<p>Illegal Instruction[EXC_BAD_INSTRUCTION // SIGILL]</p>
<p>该过程尝试执行非法或未定义的指令。该过程可能尝试通过错误配置的函数指针跳转到无效地址。</p>
<p>在Intel处理器上，ud2操作码引起EXC_BAD_INSTRUCTION异常，但通常用于进程调试目的。如果在运行时遇到意外情况，Intel处理器上的Swift代码将以此异常类型终止。有关详细信息，请参阅Trace Trap。</p>
</blockquote>
</li>
</ul>
<h1 id="五、Crash的采集"><a href="#五、Crash的采集" class="headerlink" title="五、Crash的采集"></a>五、Crash的采集</h1><h2 id="4-1-采集工具"><a href="#4-1-采集工具" class="headerlink" title="4.1 采集工具"></a>4.1 采集工具</h2><p>崩溃日志收集服务，成熟的开源项目很多，如 <a target="_blank" rel="noopener" href="https://github.com/kstenerud/KSCrash">KSCrash</a>，<a target="_blank" rel="noopener" href="https://github.com/plausiblelabs/plcrashreporter">PLCrashReporter</a>，<a target="_blank" rel="noopener" href="https://github.com/kaler/CrashKit">CrashKit</a> 等。追求方便省心，对于保密性要求不高的程序来说，也可以选择各种一条龙Crash统计产品，如 <a target="_blank" rel="noopener" href="http://try.crashlytics.com/">Crashlytics</a>，<a target="_blank" rel="noopener" href="http://hockeyapp.net/features/crashreports/">Hockeyapp</a> ，<a target="_blank" rel="noopener" href="http://www.umeng.com/umeng30_error_type">友盟</a>，<a target="_blank" rel="noopener" href="http://bugly.qq.com/">Bugly</a> 等等。</p>
<h3 id="4-1-1-官方CrashReporter"><a href="#4-1-1-官方CrashReporter" class="headerlink" title="4.1.1 官方CrashReporter"></a>4.1.1 官方CrashReporter</h3><p>iOS有自己的CrashReporter机制。在真机上产生的crash，在以下两个地方可以找到：</p>
<ul>
<li>Xcode－Window－Devices － View Device Logs中可以看到crash文件。</li>
<li>通过iTunes Connect（Manage Your Applications - View Details - Crash Reports）获取用户的crash日志。需要用户在设置-诊断与用量中允许将崩溃信息发送给开发者。然后在也可以在Xcode的Window - Organizer中可以看到对应的crash信息。（需要在Xcode中登录所属的开发者账号）</li>
</ul>
<p>关于各个字段的含义，以下仅供参考：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Incident Identifier</td>
<td>当前crash的 id，可以区分不同的crash事件</td>
</tr>
<tr>
<td>CrashReporter Key</td>
<td>当前设备的id，可以判断crash在某一设备上出现的频率</td>
</tr>
<tr>
<td>Hardware Model</td>
<td>设备型号</td>
</tr>
<tr>
<td>Process</td>
<td>当前应用的名称，后面中括号中为当前的应用在系统中的进程id</td>
</tr>
<tr>
<td>Path</td>
<td>当前应用在设备中的路径</td>
</tr>
<tr>
<td>Identifier</td>
<td>bundle id</td>
</tr>
<tr>
<td>Version</td>
<td>应用版本号</td>
</tr>
<tr>
<td>Code Type</td>
<td>还不清楚</td>
</tr>
<tr>
<td>Date/Time</td>
<td>crash事件 时间(后面跟的应该是时区)</td>
</tr>
<tr>
<td>OS Version</td>
<td>当前系统版本</td>
</tr>
<tr>
<td>Exception Type</td>
<td>异常类型</td>
</tr>
<tr>
<td>Exception Codes</td>
<td>异常出错的代码（常见代码有以下几种) <br />0x8badf00d：Watchdog超时，意为“ate bad food”。  <br />0xdeadfa11：用户强制退出，意为“dead fall”。 <br />0xbaaaaaad：用户按住Home键和音量键，获取当前内存状态，不代表崩溃。 <br />0xbad22222：VoIP应用（因为太频繁？）被iOS干掉。 <br />0xc00010ff：因为太烫了被干掉，意为“cool off”。 <br />0xdead10cc：因为在后台时仍然占据系统资源（比如通讯录）被干掉，意为“dead lock”。</td>
</tr>
<tr>
<td>Triggered by Thread</td>
<td>在某一个线程出了问题导致crash，Thread 0  为主线程、其它的都为子线程</td>
</tr>
<tr>
<td>Last Exception Backtrace</td>
<td>最后异常回溯，一般根据这个代码就能找到crash的具体问题</td>
</tr>
</tbody></table>
<h3 id="4-1-2-KSCrash"><a href="#4-1-2-KSCrash" class="headerlink" title="4.1.2 KSCrash"></a>4.1.2 KSCrash</h3><p>KSCrash 是 iOS 上一个知名的 crash 收集框架。包括腾讯刚开源的 APM 框架 Matrix，其中 crash 收集部分也是直接使用的 KSCrash。</p>
<h3 id="4-1-3-PLCrashReporter"><a href="#4-1-3-PLCrashReporter" class="headerlink" title="4.1.3 PLCrashReporter"></a>4.1.3 PLCrashReporter</h3><p>微软家的，<a target="_blank" rel="noopener" href="https://github.com/microsoft/plcrashreporter">Github</a></p>
<h2 id="4-2-多个Crash日志收集服务共存的坑"><a href="#4-2-多个Crash日志收集服务共存的坑" class="headerlink" title="4.2 多个Crash日志收集服务共存的坑"></a>4.2 多个Crash日志收集服务共存的坑</h2><p>是的，在自己的程序里集成多个Crash日志收集服务实在不是明智之举。通常情况下，第三方功能性SDK都会集成一个Crash收集服务，以及时发现自己SDK的问题。当各家的服务都以保证自己的Crash统计正确完整为目的时，难免出现时序手脚，强行覆盖等等的恶意竞争，总会有人默默被坑。</p>
<h3 id="4-2-1-拒绝传递-UncaughtExceptionHandler"><a href="#4-2-1-拒绝传递-UncaughtExceptionHandler" class="headerlink" title="4.2.1 拒绝传递 UncaughtExceptionHandler"></a>4.2.1 拒绝传递 UncaughtExceptionHandler</h3><p>如果同时有多方通过NSSetUncaughtExceptionHandler注册异常处理程序，和平的作法是：后注册者通过NSGetUncaughtExceptionHandler将先前别人注册的handler取出并备份，在自己handler处理完后自觉把别人的handler注册回去，规规矩矩的传递。不传递强行覆盖的后果是，在其之前注册过的日志收集服务写出的Crash日志就会因为取不到NSException而丢失Last Exception Backtrace等信息。（P.S. iOS系统自带的Crash Reporter不受影响）</p>
<p>在开发测试阶段，可以利用 <a target="_blank" rel="noopener" href="https://github.com/facebook/fishhook">fishhook</a> 框架去hookNSSetUncaughtExceptionHandler方法，这样就可以清晰的看到handler的传递流程断在哪里，快速定位污染环境者。不推荐利用调试器添加符号断点来检查，原因是一些Crash收集框架在调试状态下是不工作的。</p>
<p>检测代码示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> NSUncaughtExceptionHandler *g_vaildUncaughtExceptionHandler;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*ori_NSSetUncaughtExceptionHandler)</span><span class="params">( NSUncaughtExceptionHandler * )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_NSSetUncaughtExceptionHandler</span><span class="params">( NSUncaughtExceptionHandler * handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_vaildUncaughtExceptionHandler = NSGetUncaughtExceptionHandler();</span><br><span class="line">    <span class="keyword">if</span> (g_vaildUncaughtExceptionHandler != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        NSLog(@<span class="string">&quot;UncaughtExceptionHandler=%p&quot;</span>,g_vaildUncaughtExceptionHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ori_NSSetUncaughtExceptionHandler(handler);</span><br><span class="line">    NSLog(@<span class="string">&quot;%@&quot;</span>,[NSThread callStackSymbols]);</span><br><span class="line">    </span><br><span class="line">    g_vaildUncaughtExceptionHandler = NSGetUncaughtExceptionHandler();</span><br><span class="line">    NSLog(@<span class="string">&quot;UncaughtExceptionHandler=%p&quot;</span>,g_vaildUncaughtExceptionHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于越狱插件注入应用进程内部，恶意覆盖NSSetUncaughtExceptionHandler的情况，应用程序本身处理起来比较弱势，因为越狱环境下操作时序的玩法比较多权利比较大。</p>
<h3 id="4-2-2-Mach异常端口换出-信号处理Handler覆盖"><a href="#4-2-2-Mach异常端口换出-信号处理Handler覆盖" class="headerlink" title="4.2.2 Mach异常端口换出+信号处理Handler覆盖"></a>4.2.2 Mach异常端口换出+信号处理Handler覆盖</h3><p>和NSSetUncaughtExceptionHandler的情况类似，设置过的Mach异常端口和信号处理程序也有可能被干掉，导致无法捕获Crash事件。</p>
<h3 id="4-2-3-影响系统崩溃日志准确性"><a href="#4-2-3-影响系统崩溃日志准确性" class="headerlink" title="4.2.3 影响系统崩溃日志准确性"></a>4.2.3 影响系统崩溃日志准确性</h3><p>应用层参与收集Crash日志的服务方越多，越有可能影响iOS系统自带的Crash Reporter。由于进程内线程数组的变动，可能会导致系统日志中线程的Crashed 标签标记错位，可以搜索abort()等关键字来复查系统日志的准确性。</p>
<p>若程序因NSException而Crash，系统日志中的Last Exception Backtrace信息是完整准确的，不会受应用层的胡来而影响，可作为排查问题的参考线索。</p>
<h1 id="六、Crash的符号化"><a href="#六、Crash的符号化" class="headerlink" title="六、Crash的符号化"></a>六、Crash的符号化</h1><p>所谓的符号解析就是就是将崩溃日志中的地址映射成为可读的符号和源文件中的行号，方便开发者定位和修复问题。</p>
<h2 id="6-1-异常信息的查看"><a href="#6-1-异常信息的查看" class="headerlink" title="6.1 异常信息的查看"></a>6.1 异常信息的查看</h2><p>异常信息有三种类型</p>
<ol>
<li><p>已标记错误位置的，这种信息很明确了不用解析，如下：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000109708aeb</span> -[ViewController buttonClick:] + <span class="number">43</span></span><br></pre></td></tr></table></figure></li>
<li><p>有模块地址的情况，如下：</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制库名（test），调用方法(符号)的地址（0x00000001018157dc），模块地址（0x100064000）+偏移地址（24844252）</span></span><br><span class="line"><span class="symbol">test</span> <span class="number">0x00000001018157dc</span> <span class="number">0x100064000</span> + <span class="number">24844252</span>  # 偏移地址是十进制，计算时注意转<span class="number">16</span>进制</span><br></pre></td></tr></table></figure></li>
<li><p>无模块地址的情况</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法(符号)的地址-偏移地址，得到的就是模块地址  0x00000001018157dc - 24844252 = 0x100064000</span></span><br><span class="line"><span class="symbol">test</span> <span class="number">0x00000001018157dc</span> test + <span class="number">24844252</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="6-2-系统原生符号解析工具"><a href="#6-2-系统原生符号解析工具" class="headerlink" title="6.2 系统原生符号解析工具"></a>6.2 系统原生符号解析工具</h2><p>一般Xcode项目每次 release 编译后, 都会产生一个新的.dSYM文件和.app文件，这两者有一个共同的UUID.</p>
<ul>
<li>.dSYM文件是一个符号表文件, 这里面包含了一个16进制的保存函数地址映射信息的中转文件。</li>
<li>获取：xcode -&gt; window -&gt; organizer-&gt;右键你的应用 show finder-&gt;右键.xcarchive 显示包内容-&gt;dSYMs-&gt;test.app.dYSM</li>
<li>符号表是内存地址与函数名，文件名，行号的映射表。 符号表元素如下所示:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;起始地址&gt; &lt;结束地址&gt; &lt;函数&gt; [&lt;文件名:行号&gt;]</span><br></pre></td></tr></table></figure>

<h3 id="6-2-1-symbolicatecrash"><a href="#6-2-1-symbolicatecrash" class="headerlink" title="6.2.1 symbolicatecrash"></a>6.2.1 symbolicatecrash</h3><p>Xcode 提供的 <code>symbolicatecrash</code>。该命令位于：<code>/Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash</code>，是一个perl 脚本，里面整合了逐步解析的操作（也可以将命令拷贝出来，直接进行调用）。</p>
<p>用法：<code>symbolicatecrash log.crash -d xxx.app.dSYM</code></p>
<p>优点：能非常方便的符号化整份 crash 日志。</p>
<p>缺点：</p>
<ol>
<li>耗时比较久。</li>
<li>粒度比较粗，无法符号化特定的某一行。</li>
</ol>
<h3 id="6-2-2-atos"><a href="#6-2-2-atos" class="headerlink" title="6.2.2 atos"></a>6.2.2 atos</h3><p>atos命令来符号化某个特定模块加载地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">atos [-arch 架构名] [-o 符号表] [-l 模块地址] [方法地址]  <span class="comment"># 模块地址、方法地址都是运行时地址（MachO中地址+ ASLR Offset）</span></span><br><span class="line"><span class="comment"># 比如</span></span><br><span class="line">atos -o xxx.app.dSYM -arch arm64/armv7 -l loadAddress runtimeAddress <span class="comment"># 模块地址可参考6.1中计算得出</span></span><br></pre></td></tr></table></figure>

<p>优点：速度快，可以符号化特定的某一行，方便上层做缓存。</p>
<p>上面的这两个工具都有两个最大的缺陷就是：</p>
<ol>
<li>都仅仅是单机的工具，无法作为在线服务提供。</li>
<li>必须依赖 macOS 系统，因 为字节服务端基建全部基于Linux，导致无法复用集团各种平台和框架，这就带来了非常高的机器成本，部署成本和运维成本。</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/MIun-eV4_J1hXGDRjGoLaw">iOS 崩溃日志在线符号化实践</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TVRYXhiOXIsMmXZo9GmEVA">iOS 符号解析重构之路</a></li>
</ul>
<h1 id="七、Crash的分析"><a href="#七、Crash的分析" class="headerlink" title="七、Crash的分析"></a>七、Crash的分析</h1><ul>
<li>当我们拿到crash日志时，应首先从<code>crash Type</code>，<code>crash thread</code>  快速定位到造成crash的代码段。之所以首先要看这两个，是因为type能大致知道crash的类型，如果是OC类型的异常，那基本上处理起来比较简单，如果是mach signals类型的，通过查看造成crash的线程堆栈，也能快速定位到方法，举个实际项目中的例子：</li>
</ul>
<blockquote>
<p>线上有个偶现的crash，crash Type为SIGSEGV，且thread不定，子线程，主线程都会存在，但是代码段相同，由于SIGSEGV是野指针异常类型，且由于在多线程中都会触发，说明问题基本上是多线程的对象读写安全问题</p>
</blockquote>
<h1 id="八、参考链接"><a href="#八、参考链接" class="headerlink" title="八、参考链接"></a>八、参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/articles/12301">漫谈iOS Crash收集框架 - 念茜</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/04f822f929f0">iOS Mach 异常、Unix 信号 和NSException 异常</a></li>
</ul>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>Author：<a href="https://tenloy.github.io">Tenloy</a>
            <p>原文链接：<a href="https://tenloy.github.io/2021/08/01/Crash-Monitor.html">https://tenloy.github.io/2021/08/01/Crash-Monitor.html</a>
            <p>发表日期：2021.08.01 , 4:24 PM</p>
            <p>更新日期：2025.06.16 , 3:38 PM</p>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">Crative Commons 4.0 许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2021/09/02/Log.html" title= "移动端日志库设计">
                    <div class="nextTitle">移动端日志库设计</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2021/07/30/Lag-Monitor.html" title= "iOS卡顿监控与堆栈获取">
                    <div class="prevTitle">iOS卡顿监控与堆栈获取</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- gitalk评论 -->

    <!-- utteranc评论 -->

    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:luotengoto@163.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/Tenloy" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
            
                <a href="https://www.jianshu.com/u/8db1bc12db9f" class="iconfont-jian jianshu" target="_blank" title=jianshu></a>
            
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:40vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Crash%E6%A6%82%E8%BF%B0"><span class="toc-text">一、Crash概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%B8%B8%E8%A7%81Crash%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.1 常见Crash的类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 处理流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Darwin%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、Darwin操作系统简单介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%8D%95%E8%8E%B7-%E2%80%94-Mach%E5%BC%82%E5%B8%B8%E4%B8%8EUnix%E4%BF%A1%E5%8F%B7%E5%BC%82%E5%B8%B8"><span class="toc-text">三、捕获 — Mach异常与Unix信号异常</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Mach-kernel-exceptions"><span class="toc-text">3.1 Mach kernel exceptions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-Mach%E5%BC%82%E5%B8%B8%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="toc-text">3.1.1 Mach异常的产生</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-Mach%E5%BC%82%E5%B8%B8%E7%9A%84%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86"><span class="toc-text">3.1.2 Mach异常的捕获原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Unix-BSD-Signals"><span class="toc-text">3.2 Unix&#x2F;BSD Signals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E4%BF%A1%E5%8F%B7%E7%9A%84%E4%BA%A7%E7%94%9F"><span class="toc-text">3.2.1 信号的产生</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86"><span class="toc-text">3.2.2 信号的捕获原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-signal%E5%87%BD%E6%95%B0"><span class="toc-text">1. signal函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-sigaction%E5%87%BD%E6%95%B0"><span class="toc-text">2. sigaction函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BF%A1%E5%8F%B7"><span class="toc-text">3.2.3 系统中都有哪些信号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%B8%B8%E8%A7%81%E7%9A%84Mach%E5%BC%82%E5%B8%B8%E4%B8%8EUnix%E4%BF%A1%E5%8F%B7"><span class="toc-text">3.3 常见的Mach异常与Unix信号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Crash%E7%9A%84%E6%94%B6%E9%9B%86%E3%80%90%E5%AE%9E%E7%8E%B0%E3%80%91"><span class="toc-text">3.4 Crash的收集【实现】</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-Mach%E5%BC%82%E5%B8%B8%E6%96%B9%E5%BC%8F"><span class="toc-text">3.4.1 Mach异常方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-Unix%E4%BF%A1%E5%8F%B7%E6%96%B9%E5%BC%8F"><span class="toc-text">3.4.2 Unix信号方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-3-Mach%E5%BC%82%E5%B8%B8-Unix%E4%BF%A1%E5%8F%B7%E6%96%B9%E5%BC%8F"><span class="toc-text">3.4.3 Mach异常+Unix信号方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%8D%95%E8%8E%B7-%E2%80%94-%E5%BA%94%E7%94%A8%E7%BA%A7%E5%BC%82%E5%B8%B8"><span class="toc-text">四、捕获 — 应用级异常</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-NSException"><span class="toc-text">4.1 NSException</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E4%B8%BA%E4%BD%95%E8%A6%81%E5%AE%9E%E7%8E%B0-NSException-%E7%9B%91%E5%90%AC"><span class="toc-text">4.1.1 为何要实现 NSException 监听</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%B8%B8%E8%A7%81%E7%9A%84-NSException-%E5%8F%8A%E5%85%B6%E5%9C%BA%E6%99%AF"><span class="toc-text">4.1.2 常见的 NSException 及其场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-NSException%E7%B1%BB%E7%A4%BA%E4%BE%8B"><span class="toc-text">4.1.3 NSException类示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-NSException%E7%9A%84%E6%8D%95%E8%8E%B7"><span class="toc-text">4.1.4 NSException的捕获</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-5-%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-text">4.1.5 注意点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ObjC%E9%87%8E%E6%8C%87%E9%92%88%E7%B1%BB%E7%9A%84Crash"><span class="toc-text">3.2 ObjC野指针类的Crash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-C-exceptions"><span class="toc-text">4.3 C++ exceptions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%8D%95%E6%8D%89-C-%E5%BC%82%E5%B8%B8"><span class="toc-text">4.3.1 为什么要捕捉 C++异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%A6%82%E4%BD%95%E6%8D%95%E6%8D%89C-%E5%BC%82%E5%B8%B8"><span class="toc-text">4.3.2 如何捕捉C++异常</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Swift-exception"><span class="toc-text">4.4 Swift exception</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Crash%E7%9A%84%E9%87%87%E9%9B%86"><span class="toc-text">五、Crash的采集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%87%87%E9%9B%86%E5%B7%A5%E5%85%B7"><span class="toc-text">4.1 采集工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%AE%98%E6%96%B9CrashReporter"><span class="toc-text">4.1.1 官方CrashReporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-KSCrash"><span class="toc-text">4.1.2 KSCrash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-PLCrashReporter"><span class="toc-text">4.1.3 PLCrashReporter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%A4%9A%E4%B8%AACrash%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%9C%8D%E5%8A%A1%E5%85%B1%E5%AD%98%E7%9A%84%E5%9D%91"><span class="toc-text">4.2 多个Crash日志收集服务共存的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E6%8B%92%E7%BB%9D%E4%BC%A0%E9%80%92-UncaughtExceptionHandler"><span class="toc-text">4.2.1 拒绝传递 UncaughtExceptionHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-Mach%E5%BC%82%E5%B8%B8%E7%AB%AF%E5%8F%A3%E6%8D%A2%E5%87%BA-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86Handler%E8%A6%86%E7%9B%96"><span class="toc-text">4.2.2 Mach异常端口换出+信号处理Handler覆盖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E5%BD%B1%E5%93%8D%E7%B3%BB%E7%BB%9F%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97%E5%87%86%E7%A1%AE%E6%80%A7"><span class="toc-text">4.2.3 影响系统崩溃日志准确性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Crash%E7%9A%84%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="toc-text">六、Crash的符号化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%BC%82%E5%B8%B8%E4%BF%A1%E6%81%AF%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="toc-text">6.1 异常信息的查看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%94%9F%E7%AC%A6%E5%8F%B7%E8%A7%A3%E6%9E%90%E5%B7%A5%E5%85%B7"><span class="toc-text">6.2 系统原生符号解析工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-symbolicatecrash"><span class="toc-text">6.2.1 symbolicatecrash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-atos"><span class="toc-text">6.2.2 atos</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81Crash%E7%9A%84%E5%88%86%E6%9E%90"><span class="toc-text">七、Crash的分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">八、参考链接</span></a></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
    
    
    
    
        <span class="sidebar-category-name" data-categories="数据结构与算法"><span class="iconfont-archer">&#xe60a;</span>数据结构与算法</span>
    
        <span class="sidebar-category-name" data-categories="计算机组成原理"><span class="iconfont-archer">&#xe60a;</span>计算机组成原理</span>
    
        <span class="sidebar-category-name" data-categories="计算机网络"><span class="iconfont-archer">&#xe60a;</span>计算机网络</span>
    
        <span class="sidebar-category-name" data-categories="汇编语言"><span class="iconfont-archer">&#xe60a;</span>汇编语言</span>
    
        <span class="sidebar-category-name" data-categories="数据的存储与传输"><span class="iconfont-archer">&#xe60a;</span>数据的存储与传输</span>
    
        <span class="sidebar-category-name" data-categories="操作系统"><span class="iconfont-archer">&#xe60a;</span>操作系统</span>
    
        <span class="sidebar-category-name" data-categories="互联网标准RFC"><span class="iconfont-archer">&#xe60a;</span>互联网标准RFC</span>
    
        <span class="sidebar-category-name" data-categories="编译链接与装载"><span class="iconfont-archer">&#xe60a;</span>编译链接与装载</span>
    
        <span class="sidebar-category-name" data-categories="iOS"><span class="iconfont-archer">&#xe60a;</span>iOS</span>
    
        <span class="sidebar-category-name" data-categories="架构与设计模式"><span class="iconfont-archer">&#xe60a;</span>架构与设计模式</span>
    
        <span class="sidebar-category-name" data-categories="图形处理与渲染"><span class="iconfont-archer">&#xe60a;</span>图形处理与渲染</span>
    
        <span class="sidebar-category-name" data-categories="软件工程"><span class="iconfont-archer">&#xe60a;</span>软件工程</span>
    
        <span class="sidebar-category-name" data-categories="音视频处理"><span class="iconfont-archer">&#xe60a;</span>音视频处理</span>
    
        <span class="sidebar-category-name" data-categories="DSL"><span class="iconfont-archer">&#xe60a;</span>DSL</span>
    
        <span class="sidebar-category-name" data-categories="Swift"><span class="iconfont-archer">&#xe60a;</span>Swift</span>
    
        <span class="sidebar-category-name" data-categories="Git"><span class="iconfont-archer">&#xe60a;</span>Git</span>
    
        <span class="sidebar-category-name" data-categories="Web"><span class="iconfont-archer">&#xe60a;</span>Web</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 75
        </div>
        <!-- search  -->
        
            <div class="site-search popup-trigger tl-side-search"> 
                <span class="iconfont-jian search-icon">&#xe7fc;搜索</span>
            </div>
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2022 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/05</span><a class="archive-post-title" href= "/2022/05/05/sqlite.html" >iOS SQLite的使用与优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/28</span><a class="archive-post-title" href= "/2022/04/28/mmap.html" >内存映射mmap函数的原理与应用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/18</span><a class="archive-post-title" href= "/2022/03/18/avfoundation.html" >AVFoundation Programming Guide(译)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/17</span><a class="archive-post-title" href= "/2022/03/17/avframework.html" >iOS音视频库概述</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/09</span><a class="archive-post-title" href= "/2022/02/09/OAuth.html" >[转] OAuth 2.0简述</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/18</span><a class="archive-post-title" href= "/2022/01/18/wkwebview-buges.html" >WKWebView使用过程中遇到的坑</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2021 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/22</span><a class="archive-post-title" href= "/2021/11/22/bit-calculation.html" >[转] 位运算实现加、减、乘、除运算</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/10</span><a class="archive-post-title" href= "/2021/11/10/git-use.html" >Git的使用总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/21</span><a class="archive-post-title" href= "/2021/10/21/dyld-objc.html" >(六) dyld与Runtime—_objc_init、map_images、load_images</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/18</span><a class="archive-post-title" href= "/2021/10/18/compile-dynamic-link.html" >(五) Mach-O 文件的动态链接、库、Dyld(含dlopen)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/10</span><a class="archive-post-title" href= "/2021/10/10/compile-load.html" >(四) Mach-O 文件的装载、ASLR及符号地址</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/08</span><a class="archive-post-title" href= "/2021/10/08/compile-static-link.html" >(三) Mach-O 文件的静态链接</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/06</span><a class="archive-post-title" href= "/2021/10/06/compile-macho.html" >(二) Mach-O 文件结构</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/05</span><a class="archive-post-title" href= "/2021/10/05/compile-clang-llvm.html" >(一) Clang/LLVM 介绍、OC 程序的编译过程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/02</span><a class="archive-post-title" href= "/2021/10/02/makefile.html" >[转] Make 命令的使用与NodeJS案例</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/28</span><a class="archive-post-title" href= "/2021/09/28/architectural-pattern.html" >常见架构模式: MVC、MVP、MVVM、VIPER</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/25</span><a class="archive-post-title" href= "/2021/09/25/design-pattern.html" >常见的设计模式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span><a class="archive-post-title" href= "/2021/09/20/program-thought.html" >常见的编程范式</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/15</span><a class="archive-post-title" href= "/2021/09/15/graphics-processing-case.html" >图形处理(三) - 图形处理实践案例</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/15</span><a class="archive-post-title" href= "/2021/09/15/graphics-processing.html" >图形处理(二) - 图形与视频处理相关的框架</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/13</span><a class="archive-post-title" href= "/2021/09/13/image-encode-decode.html" >图形处理(一) - 图片的加载与编解码</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/12</span><a class="archive-post-title" href= "/2021/09/12/iOS-Render.html" >[转] iOS离屏渲染原理及优化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/11</span><a class="archive-post-title" href= "/2021/09/11/core-animation03.html" >Core-Animation(三) - 渲染流程探究及性能分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/09</span><a class="archive-post-title" href= "/2021/09/09/core-animation02.html" >Core Animation(二) - 隐式动画、CATransaction与CAAction</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/07</span><a class="archive-post-title" href= "/2021/09/07/core-animation01.html" >Core Animation(一) - UIView与CALayer、布局与绘制</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/05</span><a class="archive-post-title" href= "/2021/09/05/AFN-Analyse.html" >[转] AFN框架实现解析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/04</span><a class="archive-post-title" href= "/2021/09/04/nrl-session.html" >NSURLSession概述</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/02</span><a class="archive-post-title" href= "/2021/09/02/Log.html" >移动端日志库设计</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/01</span><a class="archive-post-title" href= "/2021/08/01/Crash-Monitor.html" >iOS崩溃监控与分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/30</span><a class="archive-post-title" href= "/2021/07/30/Lag-Monitor.html" >iOS卡顿监控与堆栈获取</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span><a class="archive-post-title" href= "/2021/07/29/SwiftUI.html" >SwiftUI</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/29</span><a class="archive-post-title" href= "/2021/07/29/Swift-Version-History.html" >Swift版本更新API介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/26</span><a class="archive-post-title" href= "/2021/07/26/RunLoop-Reposted-From-ibireme.html" >[转] 深入理解RunLoop—ibireme</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/25</span><a class="archive-post-title" href= "/2021/07/25/Protocol-Buffer.html" >Protocol Buffer的基本介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/24</span><a class="archive-post-title" href= "/2021/07/24/base64.html" >Base64编码及iOS中的Base64</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/23</span><a class="archive-post-title" href= "/2021/07/23/chinese-encode.html" >[转] 彻底弄懂常见的7种中文字符编码</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/10</span><a class="archive-post-title" href= "/2021/07/10/p-npc-np.html" >P问题、NP问题、NPC、NP-Hard、P=NP?</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span><a class="archive-post-title" href= "/2021/06/30/probability.html" >(六) 概率算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/28</span><a class="archive-post-title" href= "/2021/06/28/branch-bound.html" >(五) 分支限界算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/26</span><a class="archive-post-title" href= "/2021/06/26/back-track.html" >(四) 回溯法(试探算法)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/24</span><a class="archive-post-title" href= "/2021/06/24/greed.html" >(三) 贪心算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/22</span><a class="archive-post-title" href= "/2021/06/22/dynamic-programming.html" >(二) 动态规划算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/20</span><a class="archive-post-title" href= "/2021/06/20/divide-and-conquer.html" >(一) 分治算法及减治、变治算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href= "/2021/06/18/several-programming.html" >穷举、递推、迭代(辗转法)、递归算法</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/15</span><a class="archive-post-title" href= "/2021/06/15/datastruction-overview.html" >数据结构与算法概述</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span><a class="archive-post-title" href= "/2021/06/06/Web-Module.html" >前端各种模块化方案总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span><a class="archive-post-title" href= "/2021/05/27/Fiber.html" >[转] 最通俗的 React Fiber(时间分片)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span><a class="archive-post-title" href= "/2021/05/27/Coroutine.html" >[转] 什么是协程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/19</span><a class="archive-post-title" href= "/2021/05/19/DSL.html" >[转] 谈谈DSL以及DSL的应用（以CocoaPods 为例）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/03</span><a class="archive-post-title" href= "/2021/05/03/iOS-private-pod.html" >私有Pod库部署</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/29</span><a class="archive-post-title" href= "/2021/04/29/iOS-ComRouter.html" >[转] iOS的组件化方案</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/27</span><a class="archive-post-title" href= "/2021/04/27/iOS-CI.html" >iOS的持续集成</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/26</span><a class="archive-post-title" href= "/2021/04/26/Containers.html" >常见的容器概念：Linux容器、Docker容器、服务器容器</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/24</span><a class="archive-post-title" href= "/2021/04/24/Dock-Reprinted-from-RuanYIFeng.html" >[转] Docker入门教程</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/20</span><a class="archive-post-title" href= "/2021/04/20/Sync-Async.html" >同步和异步解读及编程中的使用场景</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/17</span><a class="archive-post-title" href= "/2021/04/17/Arm64-Handbook.html" >ARM64指令简易手册</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/16</span><a class="archive-post-title" href= "/2021/04/16/Arm64-Introduce.html" >iOS需要了解的ARM64汇编</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/13</span><a class="archive-post-title" href= "/2021/04/13/Command-Line.html" >CLI Shell、Terminal、脚本(语言)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/10</span><a class="archive-post-title" href= "/2021/04/10/Ins-SysCall-Kernel-Shell.html" >指令、系统调用、库、Shell、APP的层次关系</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/08</span><a class="archive-post-title" href= "/2021/04/08/ISA-Microarch-Soc.html" >指令集、微架构、手机芯片(Soc)及ARM的介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/02</span><a class="archive-post-title" href= "/2021/04/02/Engineering.html" >工程化、动态化、容器化、组件化</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/01</span><a class="archive-post-title" href= "/2021/04/01/GithubPages-Hexo.html" >使用Hexo+Github Pages搭建个人博客</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/22</span><a class="archive-post-title" href= "/2020/12/22/aes.html" >数据加密 — 对称加密(以AES为例)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/21</span><a class="archive-post-title" href= "/2020/12/21/aes-standard.html" >[转] AES标准及Rijndael算法解析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/20</span><a class="archive-post-title" href= "/2020/12/20/asymmetric.html" >数据加密 — 非对称加密(加签/加密，以RSA为例)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/09</span><a class="archive-post-title" href= "/2020/12/09/pki.html" >常见的PKI标准(X.509、PKCS)及证书相关介绍</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/28</span><a class="archive-post-title" href= "/2020/10/28/runtime-data-structure.html" >Objc Runtime总结</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/11</span><a class="archive-post-title" href= "/2020/09/11/GCD.html" >Objective-C — 深入浅出GCD常用API</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/06</span><a class="archive-post-title" href= "/2020/09/06/oc-block.html" >Objective-C — Block</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/26</span><a class="archive-post-title" href= "/2020/08/26/AutoreleasePool.html" >AutoreleasePool</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/24</span><a class="archive-post-title" href= "/2020/08/24/oc-memory-manage.html" >Objective-C — 内存管理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/01</span><a class="archive-post-title" href= "/2020/08/01/ui-navigation-bar.html" >[转] 导航栏的架构介绍及使用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/15</span><a class="archive-post-title" href= "/2020/07/15/symbol-decl.html" >变量声明、函数声明的作用</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/01</span><a class="archive-post-title" href= "/2020/07/01/ios-apns.html" >iOS APNS接收逻辑梳理</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/13</span><a class="archive-post-title" href= "/2020/06/13/ios-vest.html" >iOS制作马甲总结</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="AutoreleasePool"><span class="iconfont-archer">&#xe606;</span>AutoreleasePool</span>
    
        <span class="sidebar-tag-name" data-tags="hexo"><span class="iconfont-archer">&#xe606;</span>hexo</span>
    
        <span class="sidebar-tag-name" data-tags="GCD"><span class="iconfont-archer">&#xe606;</span>GCD</span>
    
        <span class="sidebar-tag-name" data-tags="ISA"><span class="iconfont-archer">&#xe606;</span>ISA</span>
    
        <span class="sidebar-tag-name" data-tags="Microarch"><span class="iconfont-archer">&#xe606;</span>Microarch</span>
    
        <span class="sidebar-tag-name" data-tags="Soc"><span class="iconfont-archer">&#xe606;</span>Soc</span>
    
        <span class="sidebar-tag-name" data-tags="CLI"><span class="iconfont-archer">&#xe606;</span>CLI</span>
    
        <span class="sidebar-tag-name" data-tags="Shell"><span class="iconfont-archer">&#xe606;</span>Shell</span>
    
        <span class="sidebar-tag-name" data-tags="Docker"><span class="iconfont-archer">&#xe606;</span>Docker</span>
    
        <span class="sidebar-tag-name" data-tags="ARM64"><span class="iconfont-archer">&#xe606;</span>ARM64</span>
    
        <span class="sidebar-tag-name" data-tags="多线程"><span class="iconfont-archer">&#xe606;</span>多线程</span>
    
        <span class="sidebar-tag-name" data-tags="协程"><span class="iconfont-archer">&#xe606;</span>协程</span>
    
        <span class="sidebar-tag-name" data-tags="DSL"><span class="iconfont-archer">&#xe606;</span>DSL</span>
    
        <span class="sidebar-tag-name" data-tags="Fiber"><span class="iconfont-archer">&#xe606;</span>Fiber</span>
    
        <span class="sidebar-tag-name" data-tags="dp"><span class="iconfont-archer">&#xe606;</span>dp</span>
    
        <span class="sidebar-tag-name" data-tags="Swift-Syntax"><span class="iconfont-archer">&#xe606;</span>Swift-Syntax</span>
    
        <span class="sidebar-tag-name" data-tags="SwiftUI"><span class="iconfont-archer">&#xe606;</span>SwiftUI</span>
    
        <span class="sidebar-tag-name" data-tags="RunLoop"><span class="iconfont-archer">&#xe606;</span>RunLoop</span>
    
        <span class="sidebar-tag-name" data-tags="Log"><span class="iconfont-archer">&#xe606;</span>Log</span>
    
        <span class="sidebar-tag-name" data-tags="CrashMonitor"><span class="iconfont-archer">&#xe606;</span>CrashMonitor</span>
    
        <span class="sidebar-tag-name" data-tags="LagMonitor"><span class="iconfont-archer">&#xe606;</span>LagMonitor</span>
    
        <span class="sidebar-tag-name" data-tags="AFN"><span class="iconfont-archer">&#xe606;</span>AFN</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "Tenloy"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
        <div class="site-search">
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="iconfont-archer">&#xe609;</i>
    </span>
  </div>
</div>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.8.0/dist/instantsearch.min.js" defer></script>
        <script src="/scripts/search.js" defer></script>
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


